// supabase/functions/deal_verify/index.ts
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "jsr:@supabase/supabase-js@2";

type JsonResponse = {
  ok: boolean;
  status: "ok" | "error";
  message: string;
  data?: Record<string, unknown>;
};

function json(body: JsonResponse, status = 200) {
  return new Response(JSON.stringify(body), {
    status,
    headers: {
      "Content-Type": "application/json",
      "Cache-Control": "no-store",
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Headers":
        "authorization, x-client-info, apikey, content-type",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
    },
  });
}

function isUuid(v: string) {
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v);
}

async function readJson(req: Request) {
  try {
    return await req.json();
  } catch {
    return null;
  }
}

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, {
      status: 204,
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Headers":
          "authorization, x-client-info, apikey, content-type",
        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
        "Cache-Control": "no-store",
      },
    });
  }

  try {
    const url = new URL(req.url);

    // token + action can come from GET params or POST body
    let token = (url.searchParams.get("t") || "").trim();
    let action = (url.searchParams.get("action") || "").trim().toLowerCase();
    let pin = "";

    if (req.method === "POST") {
      const body = await readJson(req);
      if (body) {
        token = String(body.t || token || "").trim();
        action = String(body.action || action || "").trim().toLowerCase();
        pin = String(body.pin || "").trim();
      }
    }

    // 1) Validate token
    if (!token || !isUuid(token)) {
      return json(
        { ok: false, status: "error", message: "Invalid verification token" },
        400,
      );
    }

    // 2) Supabase client
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const serviceKey =
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ||
      Deno.env.get("SUPABASE_ANON_KEY")!;

    const supabase = createClient(supabaseUrl, serviceKey, {
      auth: { persistSession: false },
    });

    // âœ… NEW: PIN redeem path
    // This will set redeemed_at if PIN is correct for the business linked to this redemption.
    if (action === "redeem_with_pin") {
      if (!pin) {
        return json(
          { ok: false, status: "error", message: "PIN required", data: { state: "invalid_pin" } },
          400,
        );
      }

      const { data: out, error } = await supabase.rpc("mark_redeemed_with_pin_v1", {
        p_verify_token: token,
        p_pin: pin,
      });

      if (error) {
        return json(
          { ok: false, status: "error", message: "Redeem failed", data: { hint: error.message } },
          500,
        );
      }

      // We expect your RPC returns JSON. We forward it safely.
      // Recommended RPC states:
      // - redeemed
      // - already_redeemed
      // - invalid_pin
      // - expired
      // - not_found
      if (out && typeof out === "object") {
        // normalize a little
        const state = String((out as any).state || "");
        const message = String((out as any).message || "OK");

        // If staff enters wrong PIN, show invalid_pin
        if (state === "invalid_pin") {
          return json({ ok: false, status: "error", message: "Invalid PIN", data: { ...out } }, 400);
        }

        return json({ ok: true, status: "ok", message, data: { ...out } });
      }

      // fallback
      return json({ ok: true, status: "ok", message: "OK", data: { state: "ok" } });
    }

    // 3) Default GET verification (read-only)
    const { data, error } = await supabase
      .from("deal_redemptions")
      .select("id, deal_id, redeemed_at, verify_token, verify_expires_at")
      .eq("verify_token", token)
      .maybeSingle();

    if (error) {
      return json(
        { ok: false, status: "error", message: "Database error", data: { hint: error.message } },
        500,
      );
    }
    if (!data) {
      return json({ ok: false, status: "error", message: "Token not found" }, 404);
    }

    const expiresAtMs = data.verify_expires_at ? new Date(data.verify_expires_at).getTime() : null;
    const isExpired = !!(expiresAtMs && expiresAtMs <= Date.now());

    if (data.redeemed_at) {
      return json({
        ok: true,
        status: "ok",
        message: "Already redeemed",
        data: {
          state: "redeemed",
          redemption_id: data.id,
          deal_id: data.deal_id,
          redeemed_at: data.redeemed_at,
          verify_expires_at: data.verify_expires_at,
        },
      });
    }

    if (isExpired) {
      return json(
        {
          ok: false,
          status: "error",
          message: "Token expired",
          data: {
            state: "expired",
            redemption_id: data.id,
            deal_id: data.deal_id,
            verify_expires_at: data.verify_expires_at,
          },
        },
        400,
      );
    }

    return json({
      ok: true,
      status: "ok",
      message: "Valid token",
      data: {
        state: "valid",
        redemption_id: data.id,
        deal_id: data.deal_id,
        verify_expires_at: data.verify_expires_at,
      },
    });
  } catch (e) {
    return json(
      { ok: false, status: "error", message: "Unexpected server error", data: { hint: String(e) } },
      500,
    );
  }
});
