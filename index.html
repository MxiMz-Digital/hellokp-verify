<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HelloKP — Deal Verification</title>
    <meta name="robots" content="noindex,nofollow" />
    <style>
      :root {
        --bg: #0b0f14;
        --card: #111826;
        --text: #e8eef7;
        --muted: #a9b4c5;
        --green: #22c55e;
        --red: #ef4444;
        --amber: #f59e0b;
        --blue: #60a5fa;
        --border: rgba(255, 255, 255, 0.08);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 700px at 20% 0%, rgba(96,165,250,0.12), transparent 60%),
                    radial-gradient(1000px 700px at 100% 20%, rgba(34,197,94,0.10), transparent 60%),
                    var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .wrap { width: 100%; max-width: 760px; }
      .brand {
        display: flex; align-items: center; gap: 12px;
        margin-bottom: 14px;
      }
      .logo {
        width: 44px; height: 44px; border-radius: 14px;
        background: linear-gradient(135deg, rgba(96,165,250,0.35), rgba(34,197,94,0.25));
        border: 1px solid var(--border);
      }
      h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; }
      .sub { margin: 2px 0 0; color: var(--muted); font-size: 13px; }

      .card {
        background: rgba(17,24,38,0.72);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 18px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      }

      .statusBox {
        border-radius: 18px;
        border: 1px solid var(--border);
        padding: 18px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .badge {
        width: 54px; height: 54px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        font-size: 26px;
        border: 1px solid var(--border);
      }
      .big {
        font-size: 22px;
        font-weight: 800;
        margin: 0;
        letter-spacing: 0.3px;
      }
      .msg { margin: 4px 0 0; color: var(--muted); font-size: 14px; line-height: 1.35; }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 14px;
      }
      .kv {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px 12px;
        background: rgba(255,255,255,0.02);
      }
      .k { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
      .v { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; word-break: break-all; }

      .actions {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        border-radius: 14px;
        padding: 10px 14px;
        font-size: 14px;
        font-weight: 650;
      }
      button:hover { background: rgba(255,255,255,0.07); }

      /* NEW: primary confirm button */
      .btnPrimary {
        background: rgba(34,197,94,0.16);
        border: 1px solid rgba(34,197,94,0.35);
        font-weight: 850;
        letter-spacing: 0.2px;
      }
      .btnPrimary:hover { background: rgba(34,197,94,0.22); }
      .btnPrimary:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      /* NEW: PIN UI */
      .pinWrap {
        margin-top: 12px;
        display: none;
        width: 100%;
      }
      .pinLabel {
        font-size: 13px;
        opacity: 0.85;
        margin-bottom: 6px;
      }
      .pinInput {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(0,0,0,0.25);
        color: #fff;
        font-size: 16px;
        outline: none;
      }
      .pinInput:focus {
        border-color: rgba(96,165,250,0.45);
        box-shadow: 0 0 0 3px rgba(96,165,250,0.10);
      }
      .pinError {
        margin-top: 8px;
        color: #ffb4b4;
        font-size: 13px;
        display: none;
      }

      .foot {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .pill {
        display: inline-block;
        border: 1px solid var(--border);
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255,255,255,0.03);
      }

      /* State colors */
      .ok { background: rgba(34,197,94,0.10); }
      .ok .badge { background: rgba(34,197,94,0.18); }
      .ok .big { color: var(--green); }

      .expired { background: rgba(245,158,11,0.10); }
      .expired .badge { background: rgba(245,158,11,0.18); }
      .expired .big { color: var(--amber); }

      .bad { background: rgba(239,68,68,0.10); }
      .bad .badge { background: rgba(239,68,68,0.18); }
      .bad .big { color: var(--red); }

      .loading { background: rgba(96,165,250,0.10); }
      .loading .badge { background: rgba(96,165,250,0.18); }
      .loading .big { color: var(--blue); }

      @media (max-width: 640px) {
        .row { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>HelloKP — Deal Verification</h1>
          <p class="sub">Staff view · Scan QR to verify redemption</p>
        </div>
      </div>

      <div class="card">
        <div id="statusBox" class="statusBox loading">
          <div id="badge" class="badge">⏳</div>
          <div>
            <p id="big" class="big">Checking…</p>
            <p id="msg" class="msg">Please wait while we validate this QR token.</p>
          </div>
        </div>

        <div class="row">
          <div class="kv">
            <div class="k">Token</div>
            <div class="v" id="tokenView">—</div>
          </div>
          <div class="kv">
            <div class="k">Expires at</div>
            <div class="v" id="expiresView">—</div>
          </div>
          <div class="kv">
            <div class="k">Redemption ID</div>
            <div class="v" id="redemptionView">—</div>
          </div>
          <div class="kv">
            <div class="k">Deal ID</div>
            <div class="v" id="dealView">—</div>
          </div>
        </div>

        <!-- NEW: Staff PIN area (hidden unless VALID) -->
        <div id="pinWrap" class="pinWrap">
          <div class="pinLabel">Staff PIN</div>
          <input
            id="staffPin"
            class="pinInput"
            type="password"
            inputmode="numeric"
            autocomplete="one-time-code"
            placeholder="Enter 4–6 digit PIN"
            maxlength="6"
          />
          <div id="pinError" class="pinError"></div>
        </div>

        <div class="actions">
          <!-- confirm button (hidden unless VALID) -->
          <button id="confirmBtn" class="btnPrimary" type="button" style="display:none;">
            CONFIRM REDEMPTION
          </button>

          <button id="refreshBtn" type="button">Refresh</button>
          <button id="copyBtn" type="button">Copy token</button>
        </div>

        <div class="foot">
          <span class="pill">HelloKP Verification · Phase 3C</span>
        </div>
      </div>
    </div>

    <script>
      const EDGE_VERIFY_URL =
        "https://xtoczgaklmkbvnwoyvqm.supabase.co/functions/v1/deal_verify";

      const el = (id) => document.getElementById(id);

      const statusBox = el("statusBox");
      const badge = el("badge");
      const big = el("big");
      const msg = el("msg");

      const tokenView = el("tokenView");
      const expiresView = el("expiresView");
      const redemptionView = el("redemptionView");
      const dealView = el("dealView");

      const refreshBtn = el("refreshBtn");
      const copyBtn = el("copyBtn");
      const confirmBtn = el("confirmBtn");

      const pinWrap = el("pinWrap");
      const staffPin = el("staffPin");
      const pinError = el("pinError");

      function setState(state, emoji, title, message) {
        statusBox.className = "statusBox " + state;
        badge.textContent = emoji;
        big.textContent = title;
        msg.textContent = message;
      }

      function fmt(ts) {
        if (!ts) return "—";
        try {
          const d = new Date(ts);
          return d.toLocaleString();
        } catch {
          return String(ts);
        }
      }

      function clearDetails() {
        expiresView.textContent = "—";
        redemptionView.textContent = "—";
        dealView.textContent = "—";
      }

      function getTokenFromUrl() {
        const url = new URL(window.location.href);
        return (url.searchParams.get("t") || "").trim();
      }

      function showPin(show) {
        pinWrap.style.display = show ? "block" : "none";
        if (!show) {
          staffPin.value = "";
          pinError.style.display = "none";
          pinError.textContent = "";
        }
      }

      function showPinError(text) {
        pinError.textContent = text || "Invalid PIN.";
        pinError.style.display = "block";
      }

      function showConfirm(show) {
        confirmBtn.style.display = show ? "inline-block" : "none";
        confirmBtn.disabled = false;
        confirmBtn.textContent = "CONFIRM REDEMPTION";
      }

      async function confirmRedemptionWithPin(token) {
        if (!token) return;

        const pin = (staffPin.value || "").trim();

        pinError.style.display = "none";
        pinError.textContent = "";

        if (!pin || pin.length < 4) {
          showPinError("Please enter staff PIN (4–6 digits).");
          return;
        }

        confirmBtn.disabled = true;
        confirmBtn.textContent = "CONFIRMING…";

        try {
          // ✅ NEW: PIN-protected confirm via Edge Function
          const res = await fetch(
            EDGE_VERIFY_URL +
              "?t=" +
              encodeURIComponent(token) +
              "&action=confirm_pin" +
              "&pin=" +
              encodeURIComponent(pin),
            { method: "GET", cache: "no-store" }
          );

          const body = await res.json().catch(() => null);

          if (!body) {
            setState("bad","⚠️","Server error","Could not read server response.");
            showConfirm(false);
            showPin(false);
            return;
          }

          // If server explicitly returns PIN error, show it nicely
          if (body.ok === false && body.message) {
            const m = String(body.message);
            if (m.toLowerCase().includes("pin")) {
              showPinError(body.message);
              // Keep VALID state visible; do not hide confirm
              confirmBtn.disabled = false;
              confirmBtn.textContent = "CONFIRM REDEMPTION";
              return;
            }
          }

          // After confirm attempt, re-render using same handler
          renderFromResponse(res, body, token);
        } catch (e) {
          setState("bad","⚠️","Network error","Unable to reach verification server.");
          showConfirm(false);
          showPin(false);
        }
      }

      function renderFromResponse(res, body, token) {
        const data = body.data || {};
        const state = data.state ? String(data.state) : "";
        const redeemedAt = data.redeemed_at ? String(data.redeemed_at) : "";
        const verifiedAt = data.verified_at ? String(data.verified_at) : "";

        // Populate details if present
        expiresView.textContent = fmt(data.verify_expires_at);
        redemptionView.textContent = data.redemption_id || "—";
        dealView.textContent = data.deal_id || "—";

        // Hard errors
        if (res.status === 400 && body.message === "Invalid verification token") {
          setState("bad","❌","Invalid QR","This token format is invalid.");
          showConfirm(false);
          showPin(false);
          return;
        }
        if (res.status === 404 && body.message === "Token not found") {
          setState("bad","❌","Not found","This token does not exist in the system.");
          showConfirm(false);
          showPin(false);
          return;
        }

        // verified (just confirmed now)
        if (state === "verified") {
          setState(
            "ok",
            "✅",
            "VERIFIED",
            verifiedAt
              ? ("Staff confirmed at " + fmt(verifiedAt) + ".")
              : "Staff confirmed this redemption."
          );
          showConfirm(false);
          showPin(false);
          return;
        }

        if (state === "already_verified") {
          setState(
            "expired",
            "✅",
            "ALREADY VERIFIED",
            verifiedAt
              ? ("Staff already verified at " + fmt(verifiedAt) + ".")
              : "This redemption was already verified earlier."
          );
          showConfirm(false);
          showPin(false);
          return;
        }

        if (state === "redeemed") {
          setState(
            "expired",
            "✅",
            "ALREADY REDEEMED",
            redeemedAt
              ? ("Redeemed at " + fmt(redeemedAt) + ". Do not accept again.")
              : "This deal was already used. Do not accept again."
          );
          showConfirm(false);
          showPin(false);
          return;
        }

        if (state === "expired") {
          setState("expired","⏱️","Expired","This token has expired. Ask customer to re-generate.");
          showConfirm(false);
          showPin(false);
          return;
        }

        if (state === "valid") {
          setState("ok","✅","VALID","This redemption is valid. Enter PIN, then tap CONFIRM to approve.");
          showConfirm(true);
          showPin(true);

          // wire up click
          confirmBtn.onclick = () => confirmRedemptionWithPin(token);

          // nice UX: hit Enter to confirm
          staffPin.onkeydown = (e) => {
            if (e.key === "Enter") confirmRedemptionWithPin(token);
          };

          return;
        }

        // Legacy fallbacks
        if (body.ok && body.message === "Already verified") {
          setState("expired","✅","ALREADY VERIFIED","This redemption was already verified earlier.");
          showConfirm(false);
          showPin(false);
          return;
        }
        if (!body.ok && body.message === "Token expired") {
          setState("expired","⏱️","Expired","This token has expired. Ask customer to re-generate.");
          showConfirm(false);
          showPin(false);
          return;
        }
        if (body.ok && body.message === "Valid token") {
          setState("ok","✅","VALID","This redemption is valid. Enter PIN, then tap CONFIRM to approve.");
          showConfirm(true);
          showPin(true);
          confirmBtn.onclick = () => confirmRedemptionWithPin(token);
          staffPin.onkeydown = (e) => {
            if (e.key === "Enter") confirmRedemptionWithPin(token);
          };
          return;
        }

        setState("bad","⚠️","Unexpected response", body.message || "Unknown validation response.");
        showConfirm(false);
        showPin(false);
      }

      async function verify() {
        const token = getTokenFromUrl();

        tokenView.textContent = token || "—";
        clearDetails();
        showConfirm(false);
        showPin(false);

        if (!token) {
          setState("bad","❌","Missing token","This QR code does not include a verification token.");
          return;
        }

        setState("loading","⏳","Checking…","Validating this redemption token…");

        try {
          const res = await fetch(
            EDGE_VERIFY_URL + "?t=" + encodeURIComponent(token),
            { method: "GET", cache: "no-store" }
          );

          const body = await res.json().catch(() => null);

          if (!body) {
            setState("bad","⚠️","Server error","Could not read server response.");
            return;
          }

          renderFromResponse(res, body, token);
        } catch (e) {
          setState("bad","⚠️","Network error","Unable to reach verification server.");
        }
      }

      refreshBtn.addEventListener("click", () => verify());

      copyBtn.addEventListener("click", async () => {
        const token = getTokenFromUrl();
        if (!token) return;
        try {
          await navigator.clipboard.writeText(token);
          copyBtn.textContent = "Copied ✅";
          setTimeout(() => (copyBtn.textContent = "Copy token"), 1200);
        } catch {}
      });

      verify();
    </script>
  </body>
</html>
