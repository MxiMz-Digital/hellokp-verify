<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HelloKP — Deal Verification</title>
    <meta name="robots" content="noindex,nofollow" />
    <style>
      :root {
        --bg: #0b0f14;
        --card: #111826;
        --text: #e8eef7;
        --muted: #a9b4c5;
        --green: #22c55e;
        --red: #ef4444;
        --amber: #f59e0b;
        --blue: #60a5fa;
        --border: rgba(255, 255, 255, 0.08);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 700px at 20% 0%, rgba(96,165,250,0.12), transparent 60%),
                    radial-gradient(1000px 700px at 100% 20%, rgba(34,197,94,0.10), transparent 60%),
                    var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .wrap { width: 100%; max-width: 760px; }
      .brand {
        display: flex; align-items: center; gap: 12px;
        margin-bottom: 14px;
      }
      .logo {
        width: 44px; height: 44px; border-radius: 14px;
        background: linear-gradient(135deg, rgba(96,165,250,0.35), rgba(34,197,94,0.25));
        border: 1px solid var(--border);
      }
      h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; }
      .sub { margin: 2px 0 0; color: var(--muted); font-size: 13px; }

      .card {
        background: rgba(17,24,38,0.72);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 18px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      }

      .statusBox {
        border-radius: 18px;
        border: 1px solid var(--border);
        padding: 18px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .badge {
        width: 54px; height: 54px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        font-size: 26px;
        border: 1px solid var(--border);
      }
      .big {
        font-size: 22px;
        font-weight: 800;
        margin: 0;
        letter-spacing: 0.3px;
      }
      .msg { margin: 4px 0 0; color: var(--muted); font-size: 14px; line-height: 1.35; }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 14px;
      }
      .kv {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px 12px;
        background: rgba(255,255,255,0.02);
      }
      .k { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
      .v { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; word-break: break-all; }

      .actions {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      button {
        cursor: pointer;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        border-radius: 14px;
        padding: 10px 14px;
        font-size: 14px;
        font-weight: 650;
      }
      button:hover { background: rgba(255,255,255,0.07); }

      .foot {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .pill {
        display: inline-block;
        border: 1px solid var(--border);
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255,255,255,0.03);
      }

      /* State colors */
      .ok { background: rgba(34,197,94,0.10); }
      .ok .badge { background: rgba(34,197,94,0.18); }
      .ok .big { color: var(--green); }

      .expired { background: rgba(245,158,11,0.10); }
      .expired .badge { background: rgba(245,158,11,0.18); }
      .expired .big { color: var(--amber); }

      .bad { background: rgba(239,68,68,0.10); }
      .bad .badge { background: rgba(239,68,68,0.18); }
      .bad .big { color: var(--red); }

      .loading { background: rgba(96,165,250,0.10); }
      .loading .badge { background: rgba(96,165,250,0.18); }
      .loading .big { color: var(--blue); }

      @media (max-width: 640px) {
        .row { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>HelloKP — Deal Verification</h1>
          <p class="sub">Staff view · Scan QR to verify redemption</p>
        </div>
      </div>

      <div class="card">
        <div id="statusBox" class="statusBox loading">
          <div id="badge" class="badge">⏳</div>
          <div>
            <p id="big" class="big">Checking…</p>
            <p id="msg" class="msg">Please wait while we validate this QR token.</p>
          </div>
        </div>

        <div class="row">
          <div class="kv">
            <div class="k">Token</div>
            <div class="v" id="tokenView">—</div>
          </div>
          <div class="kv">
            <div class="k">Expires at</div>
            <div class="v" id="expiresView">—</div>
          </div>
          <div class="kv">
            <div class="k">Redemption ID</div>
            <div class="v" id="redemptionView">—</div>
          </div>
          <div class="kv">
            <div class="k">Deal ID</div>
            <div class="v" id="dealView">—</div>
          </div>
        </div>

        <div class="actions">
          <button id="refreshBtn" type="button">Refresh</button>
          <button id="copyBtn" type="button">Copy token</button>
        </div>

        <div class="foot">
          <span class="pill">HelloKP Verification · Phase 2A</span>
        </div>
      </div>
    </div>

    <script>
      const EDGE_VERIFY_URL =
        "https://xtoczgaklmkbvnwoyvqm.supabase.co/functions/v1/deal_verify";

      const el = (id) => document.getElementById(id);

      const statusBox = el("statusBox");
      const badge = el("badge");
      const big = el("big");
      const msg = el("msg");

      const tokenView = el("tokenView");
      const expiresView = el("expiresView");
      const redemptionView = el("redemptionView");
      const dealView = el("dealView");

      const refreshBtn = el("refreshBtn");
      const copyBtn = el("copyBtn");

      function setState(state, emoji, title, message) {
        statusBox.className = "statusBox " + state;
        badge.textContent = emoji;
        big.textContent = title;
        msg.textContent = message;
      }

      function fmt(ts) {
        if (!ts) return "—";
        try {
          const d = new Date(ts);
          return d.toLocaleString();
        } catch {
          return String(ts);
        }
      }

      function clearDetails() {
        expiresView.textContent = "—";
        redemptionView.textContent = "—";
        dealView.textContent = "—";
      }

      async function verify() {
        const url = new URL(window.location.href);
        const token = (url.searchParams.get("t") || "").trim();

        tokenView.textContent = token || "—";
        clearDetails();

        if (!token) {
          setState("bad","❌","Missing token","This QR code does not include a verification token.");
          return;
        }

        setState("loading","⏳","Checking…","Validating this redemption token…");

        try {
          const res = await fetch(
            EDGE_VERIFY_URL + "?t=" + encodeURIComponent(token),
            { method: "GET", cache: "no-store" }
          );

          const body = await res.json().catch(() => null);

          if (!body) {
            setState("bad","⚠️","Server error","Could not read server response.");
            return;
          }

          const data = body.data || {};
          const state = data.state ? String(data.state) : "";
          const redeemedAt = data.redeemed_at ? String(data.redeemed_at) : "";
          const verifiedAt = data.verified_at ? String(data.verified_at) : "";

          // Populate details if present
          expiresView.textContent = fmt(data.verify_expires_at);
          redemptionView.textContent = data.redemption_id || "—";
          dealView.textContent = data.deal_id || "—";

          // Hard errors
          if (res.status === 400 && body.message === "Invalid verification token") {
            setState("bad","❌","Invalid QR","This token format is invalid.");
            return;
          }
          if (res.status === 404 && body.message === "Token not found") {
            setState("bad","❌","Not found","This token does not exist in the system.");
            return;
          }

          // ✅ Preferred: server state handling
          if (state === "already_verified") {
            setState(
              "expired",
              "✅",
              "ALREADY VERIFIED",
              verifiedAt
                ? ("Staff already verified at " + fmt(verifiedAt) + ".")
                : "This redemption was already verified earlier."
            );
            return;
          }

          if (state === "redeemed") {
            setState(
              "expired",
              "✅",
              "ALREADY REDEEMED",
              redeemedAt
                ? ("Redeemed at " + fmt(redeemedAt) + ". Do not accept again.")
                : "This deal was already used. Do not accept again."
            );
            return;
          }

          if (state === "expired") {
            setState("expired","⏱️","Expired","This token has expired. Ask customer to re-generate.");
            return;
          }

          if (state === "valid") {
            setState("ok","✅","VALID","This redemption is valid. You may accept it.");
            return;
          }

          // Legacy fallbacks
          if (body.ok && body.message === "Already verified") {
            setState("expired","✅","ALREADY VERIFIED","This redemption was already verified earlier.");
            return;
          }
          if (!body.ok && body.message === "Token expired") {
            setState("expired","⏱️","Expired","This token has expired. Ask customer to re-generate.");
            return;
          }
          if (body.ok && body.message === "Valid token") {
            setState("ok","✅","VALID","This redemption is valid. You may accept it.");
            return;
          }

          setState("bad","⚠️","Unexpected response", body.message || "Unknown validation response.");
        } catch (e) {
          setState("bad","⚠️","Network error","Unable to reach verification server.");
        }
      }

      refreshBtn.addEventListener("click", () => verify());

      copyBtn.addEventListener("click", async () => {
        const token = (new URL(window.location.href).searchParams.get("t") || "").trim();
        if (!token) return;
        try {
          await navigator.clipboard.writeText(token);
          copyBtn.textContent = "Copied ✅";
          setTimeout(() => (copyBtn.textContent = "Copy token"), 1200);
        } catch {}
      });

      verify();
    </script>
  </body>
</html>
